# 杂项/翻墙软件的协议设计

## 翻墙软件存在的土壤

- [百度和谷歌的差距在哪里, 为什么会产生这样大的差距?](https://www.zhihu.com/question/39448356/answer/2350040602).
- [中文互联网的产出在渐渐枯萎吗?](https://www.zhihu.com/question/49684783).
- [假新闻和情绪化报道——后真相时代的信任异化](https://zhuanlan.zhihu.com/p/42989250).
    - **资治通鉴 唐太宗贞观二年**: 上(唐太宗)问魏徵曰: 人主何为而明, 何为而暗? 对曰: 兼听则明, 偏信则暗.

## 翻墙行为中的参与方

人群中一般存在两个派系

**购买机场**

```
+ -------- +     + --- +     + ------------ +     + ---- +
| Internet | <-> | GFW | <-> |   Airport    | <-> | User |
+ -------- +     + --- +     + ------------ +     + ---- +
```

**自建**

```
+ -------- +     + --- +     + ------------ +     + ---- +
| Internet | <-> | GFW | <-> | Cloud server | <-> | User |
+ -------- +     + --- +     + ------------ +     + ---- +
```

- Self hosting
- Don't trust verify

## 各个参与方的目标与态度

本文我们主要谈第二种, 也就是自建翻墙服务.

- 用户
    - 目标: 翻墙成功, 并且未被云服务器提供商和 GFW 检测出
    - 态度: 安全, 稳定
- 云服务商
    - 目标: 卖服务器赚钱, 且希望用户未架设翻墙工具或架设了翻墙工具但未被 GFW 检测
    - 态度: 会有一套工具来检测用户是否搭建了翻墙服务, 但对翻墙行为并不会赶尽杀绝
        - 云服务商可以取得全部出口流量, 因此它事实上知道你的服务器和 Google 有数据交换
- 防火墙:
    - 目标: 及时发现翻墙行为并进行阻断

## 经典代理协议

有一些经典的代理协议: HTTP Proxy, Socks4, Socks4a, Socks5 ... 这些协议是客户端应用程序访问代理服务器的协议. 有很多这样的代理工具, 例如 Chrome 浏览器上的 SwitchyOmega 插件.

![img](/img/misc/breakwall/switchy_omega.jpg)

在 7 层网络模型下, 以上的这些协议作用在不同的层级上:

```text
7-应用层 <--------- HTTP Proxy
6-表示层
5-会话层
4-传输层 <--------- Socks4, Socks4a, Socks5
3-网络层
2-数据链路层
1-物理层
```

- HTTP Proxy: 应用层协议, 只能代理 HTTP 请求, 应用场景十分受限
- Socks4: 传输层协议, 支持代理 TCP 流量
- Socks4a: Socks4 的升级版, 相比较 Socks4, 允许远程 DNS 解析, 可以解决 DNS 投毒
    - DNS 投毒: 网络供应商伪造 DNS 回应, 使用户拿到域名对应的错误的 IP 地址
- Socks5: 相比 Socks4, 支持 UDP 协议, 最为通用.  [RFC](https://datatracker.ietf.org/doc/html/rfc1928).
- Socks6: 目前为草稿状态. [RFC](https://tools.ietf.org/id/draft-olteanu-intarea-socks-6-00.html). 对于 Socks5 来讲一次链接的建立需要 2 次 RTT, Socks6 将 RTT 减少到了 1.
    - RTT: 客户端一次请求, 服务端一次应答为一次 RTT. 一个极端的例子, 假设客户端在大陆, 服务器在美国, 信号以光速传播, 那么大陆到美国一次 RTT 需要的最短时间是 `2 *（20000km / 光速）= 0.133s = 133ms`, Socks6 对体验的提升是非常直观的.

## 经典代理协议面对 GFW 的失效

```text
+ ------- +          + -------------------- +           + ----- +            + ---- +
| Google  | <------> | 提供 Socks5 的服务器 | <-------> |  GFW  | <--------> | 用户 |
+ ------- +          + -------------------- +           + ----- +            + ---- +
                     |         美国         |                                | 大陆 |
                     + -------------------- +                                + ---- +
```

HTTP Proxy, Socks4, Socks4a, Socks5 ... 这些协议都是明文协议, 当用户使用这些协议与海外机器通信时, GFW 可以进行识别.

## 新的尝试

既然用户无法建立到海外的直接 Socks5 连接, 那么一个直观的解决方法就是加一层.

> 计算机科学中的每个问题都可以用一间接层解决 -- David Wheeler.

![img](/img/misc/breakwall/david_wheeler.jpg)

```
+ ------- +          + ---------- +           + ----- +            + ---------- +         + ---- +
| Google  | <------> | 翻墙服务器 | <-------> |  GFW  | <--------> | 翻墙客户端 | <-----> | 用户 |
+ ------- +          + ---------- +           + ----- +            + ---------- +         + ---- +
                         |                                                |
                         |                                                |
                         + <------- 可绕过 GFW 检测的代理协议 ----------> +
```

用户和翻墙客户端之间通过 HTTP Proxy, Socks4, Socks4a, Socks5 ... 协议通信. 这方面的先驱者就是 shadowsocks.

![img](/img/misc/breakwall/shadowsocks.png)

## 加密

我们的困难在于明文协议会被 GFW 识别, 因此只需要有一个简单的办法对协议进行加密即可. 鉴于 TCP 是流协议, 因此可以采用一个流加密算法.

**RC4** 是一个可行的算法: [https://en.wikipedia.org/wiki/RC4](https://en.wikipedia.org/wiki/RC4)

```text
i := 0
j := 0
while GeneratingOutput:
    i := (i + 1) mod 256
    j := (j + S[i]) mod 256
    swap values of S[i] and S[j]
    K := S[(S[i] + S[j]) mod 256]
    output K
endwhile
```

- 难以置信的性能
- 对称加密

## 你不是对手!

我明明已经加过密了, 为什么还是被封啊...

**与服务器协商过程中特征过于明显**

![img](/img/misc/breakwall/doge.png)

右图隐去了颜色, 毛发, 环境背景等信息, 但依然可以一眼看出 doge, 因为其轮廓信息存在, 并且十分明显. 对流量加密只隐藏了流量的传输内容, 但下列特征无法依靠加密消除:

- 与服务器建立连接后的 RTT 次数.
- 每次 RTT 传输的数据量.
- 与服务器进行信息交互的频率.

如果考虑大多数人使用翻墙是为了浏览网页, 其特征可以更加明显:

- Chrome 最多可以建立 10 个链接, 对于单 IP 最大可以建立 6 个链接.
- 在打开网页的时候会瞬间建立多个 TCP 连接
- ... ...

如果 GFW 发现某台服务器的行为均是短时间内建立大量 TCP 连接(用户打开网页的时候), 并且其每次突发时最大 TCP 连接数总是在 10 以内, 就可以进行合理的猜测.

**反向端口扫描**

常用的反爬虫/代理手段.

假设可以取得海外网站的访客 IP 列表, 就可以反向去连接这些 IP 的 22 端口, 如果可以建立连接, 证明这些 IP 来自服务器.

**重放攻击**

**数据大小比对**

## 9. 尝试解决方案

## 10. 化为无形

TCP over FTP

## 加速

RTT 为 0

## 11. 对抗螺旋上升, 没有止境

- [前几天去泉州体验了一把白名单](https://www.v2ex.com/t/851473)

## 12. 发现问题, 解决问题
