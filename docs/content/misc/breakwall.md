# 杂项/翻墙软件的协议设计

## 翻墙软件存在的土壤

- [百度和谷歌的差距在哪里, 为什么会产生这样大的差距?](https://www.zhihu.com/question/39448356/answer/2350040602).
- [中文互联网的产出在渐渐枯萎吗?](https://www.zhihu.com/question/49684783).
- [假新闻和情绪化报道——后真相时代的信任异化](https://zhuanlan.zhihu.com/p/42989250).
    - **资治通鉴 唐太宗贞观二年**: 上(唐太宗)问魏徵曰: 人主何为而明, 何为而暗? 对曰: 兼听则明, 偏信则暗.

## 翻墙行为中的参与方

**购买机场**

```
+ -------- +     + --- +     + ------------ +     + ---- +
| Internet | <-> | GFW | <-> |   Airport    | <-> | User |
+ -------- +     + --- +     + ------------ +     + ---- +
```

**自建**

```
+ -------- +     + --- +     + ------------ +     + ---- +
| Internet | <-> | GFW | <-> | Cloud server | <-> | User |
+ -------- +     + --- +     + ------------ +     + ---- +
```

## 各个参与方的目标与态度

本文我们主要谈第二种, 也就是自建翻墙服务.

- 用户
    - 目标: 翻墙成功, 并且未被云服务器提供商和 GFW 检测出
    - 态度: 安全 > 稳定
- 云服务商
    - 目标: 卖服务器赚钱, 且希望用户未架设翻墙工具或架设了翻墙工具但未被 GFW 检测
    - 态度: 会有一套工具来检测用户是否搭建了翻墙服务, 但对翻墙行为并不会赶尽杀绝
- 防火墙:
    - 目标: 及时发现翻墙行为并进行阻断

## 早期尝试

有一些经典的代理协议: HTTP Proxy, Socks4, Socks4a, Socks5 ...

这些协议是客户端应用程序访问代理服务器的协议. 有很多这样的代理工具, 例如 Chrome 浏览器上的 SwitchyOmega 插件.

![img](/img/misc/breakwall/switchy_omega.jpg)

不同的协议作用在不同的层级上:

```text
7-应用层 <--------- HTTP Proxy
6-表示层
5-会话层
4-传输层 <--------- Socks4, Socks4a, Socks5
3-网络层
2-数据链路层
1-物理层
```

- HTTP Proxy: 应用层协议, 只能代理 HTTP 请求
- Socks4: 传输层协议, 支持 TCP 协议
- Socks4a: Socks4 的升级版, 允许远程 DNS 解析, 解决了 DNS 投毒
- Socks5: 相比 Socks4, 支持 UDP 协议, 最为通用.  [RFC](https://datatracker.ietf.org/doc/html/rfc1928)

## 5. 危机

```
+ ------- +          + -------------------- +           + ----- +            + -- +
| Google  | <------> | 提供 Socks5 的服务器 | <-------> |  GFW  | <--------> | 你 |
+ ------- +          + -------------------- +           + ----- +            + -- +
```

上述协议都是明文协议, 当你在访问 Socks5 服务器时 GFW 可以知晓你的动作.

## 6. 故事开始

```
+ ------- +          + ------ +           + ----- +            + ------------------------ +         + -- +
| Google  | <------> | 服务器 | <-------> |  GFW  | <--------> | 提供 Socks5 服务的客户端 | <-----> | 你 |
+ ------- +          + ------ +           + ----- +            + ------------------------ +         + -- +
                         |                                                      |
                         |                                                      |
                         + <-------- 可绕过 GFW 检测的代理协议 ---------------> +
```

## 7. 理所当然的直觉: 加密

如果我们传输的是加密后的数据, 不就可以绕过 GFW 的检测?

流加密, RC4.

## 8. 为什么还是会被封, 数据明明已经加过密了?

- 密钥协商过程中特征过于明显
- 反向端口扫描
- 重放攻击
- 数据大小比对

## 9. 尝试解决方案

## 10. 化为无形

TCP over FTP

## 11. 对抗螺旋上升, 没有止境

## 12. 发现问题, 解决问题
